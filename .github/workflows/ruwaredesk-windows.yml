name: RuwareDesk Windows Build

on:
  # Запуск руками через GitHub UI или gh
  workflow_dispatch:

  # Автоматический запуск при пуше в master (можно оставить, удобно)
  push:
    branches: [ master ]
    paths:
      - "flutter/**"
      - "src/**"
      - "libs/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/ruwaredesk-windows.yml"

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      FLUTTER_VERSION: 3.24.5
      RUST_TOOLCHAIN: 1.75.0

    steps:
      - name: Checkout repo with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Enable Windows desktop for Flutter
        run: flutter config --enable-windows-desktop
        working-directory: flutter

      - name: Flutter pub get
        run: flutter pub get
        working-directory: flutter

      - name: Build RuwareDesk Windows (Flutter)
        run: flutter build windows --release
        working-directory: flutter

      - name: Collect RuwareDesk artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          cp build/windows/x64/runner/Release/*.exe artifacts/
        working-directory: flutter

      - name: Upload RuwareDesk Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: RuwareDesk-windows-x86_64
          path: flutter/artifacts
